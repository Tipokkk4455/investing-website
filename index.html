<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<title>‡πÄ‡∏ß‡πá‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f8fafc;--card:#ffffff;--accent:#3b82f6;--accent-hover:#2563eb;--muted:#64748b;--border:#e2e8f0;--danger:#ef4444;--success:#10b981;}
  body{font-family:'Kanit',sans-serif;background:var(--bg);margin:0;padding:20px;display:flex;justify-content:center;color:#334155;line-height:1.5;}
  .wrap{max-width:900px;width:100%}
  h1{color:#1e293b;margin:0 0 20px;text-align:center;font-weight:600;}
  .card{background:var(--card);padding:24px;border-radius:20px;box-shadow:0 10px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.01);}
  .nav-link { text-decoration: none; color: #64748b; font-size: 14px; transition: 0.2s; }
  .nav-link:hover { color: var(--accent); }

  .grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:16px;}
  .full{grid-column:1/ -1;}

  label{font-weight:500;display:block;margin-bottom:6px;color:#475569;font-size:14px;}
  input,select,button{font-family:'Kanit',sans-serif;}
  input,select{width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--border);font-size:15px;box-sizing:border-box;transition:all 0.2s;background:#fff;}
  input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.15);}
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  
  .hint{font-size:0.85em;color:var(--muted);margin-left:4px;}

  .btn-group{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;}
  button{padding:10px 16px;border-radius:10px;border:none;font-size:15px;cursor:pointer;font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;justify-content:center;gap:6px;}
  button.primary{background:var(--accent);color:#fff;box-shadow:0 4px 6px -1px rgba(59,130,246,0.2);}
  button.primary:hover{background:var(--accent-hover);transform:translateY(-1px);}
  button.secondary{background:#fff;border:1px solid var(--border);color:#475569;}
  button.secondary:hover{background:#f1f5f9;border-color:#cbd5e1;}
  button.danger{background:#fff;border:1px solid var(--danger);color:var(--danger);}
  button.danger:hover{background:#fef2f2;}
  button.success{background:var(--success);color:#fff;}
  
  .result-box{background:linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);border:1px solid #bfdbfe;padding:20px;border-radius:12px;margin-top:20px;animation:fadeIn 0.3s ease;}
  .error{color:#b91c1c;font-weight:500;padding:12px;background:#fef2f2;border-radius:8px;border:1px solid #fecaca;}

  /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤ */
  .math-box {
    background: #f8fafc;
    border: 1px solid #cbd5e1;
    border-left: 5px solid #3b82f6;
    padding: 15px;
    margin-top: 20px;
    border-radius: 6px;
    font-size: 0.95em;
  }
  .math-section { margin-bottom: 12px; }
  .math-section:last-child { margin-bottom: 0; }
  .math-label { font-weight: 600; color: #475569; margin-bottom: 4px; display: block; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
  .math-code { 
    font-family: 'Courier New', monospace; 
    color: #334155; 
    background: #fff;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    display: block;
    overflow-x: auto;
  }
  .math-hl { color: #2563eb; font-weight: bold; }

  .entries{display:flex;flex-direction:column;gap:12px;margin-top:16px;}
  .entry{background:#fff;padding:16px;border-radius:12px;border:1px solid var(--border);display:flex;flex-direction:column;gap:10px;position:relative;overflow:hidden;}
  .entry-header{display:flex;justify-content:space-between;align-items:flex-start;}
  .entry h3{margin:0;font-size:16px;color:#1e293b;font-weight:600;}
  .entry .meta{color:var(--muted);font-size:13px;margin-top:2px;}
  .entry-content{background:#f8fafc;padding:10px;border-radius:6px;font-family:monospace;font-size:13px;white-space:pre-wrap;color:#475569;}
  .entry-actions{display:flex;gap:8px;justify-content:flex-end;}
  .badge{display:inline-block;padding:4px 10px;border-radius:20px;background:#e0f2fe;color:#0369a1;font-weight:600;font-size:13px;}

  .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
  .schedule-wrap{margin-top:12px;background:#fff;border:1px solid var(--border);padding:0;border-radius:10px;overflow:hidden;}
  table{width:100%;border-collapse:collapse;font-size:13px;}
  th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:right;}
  th{background:#f8fafc;text-align:center;font-weight:600;color:#64748b;}
  .warn{color:#b45309;background:#fffbeb;padding:10px;border-radius:6px;margin-bottom:8px;}
  canvas{width:100%;height:280px;border-radius:12px;margin-top:10px;background:#fff;border:1px solid var(--border);}

  @keyframes fadeIn { from{opacity:0;transform:translateY(5px);} to{opacity:1;transform:translateY(0);} }
  @media (max-width:760px){
    .grid{grid-template-columns:1fr;}
    .btn-group{flex-direction:column;align-items:stretch;}
  }
</style>
</head>
<nav>
    <div class="nav-logo" style="padding: 10px 20px; font-weight:bold; font-size:1.2em;">StockGrowth Pro</div>
</nav>
<body>
  <div class="wrap" role="main">
    <h1>‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô  <small style="font-size:0.5em;color:#64748b">by PlutoNo1</small></h1>
    <div class="card">
      <div class="grid">
        
        <div class="full">
          <label for="entryName"> ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Optional)</label>
          <input id="entryName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ú‡∏ô‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì, ‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏ñ, ‡∏ù‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥ 3 ‡∏õ‡∏µ">
        </div>

        <div class="full">
          <label for="mode"> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</label>
          <select id="mode" onchange="updateInputs()">
            <optgroup label="‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Lump Sum)">
                <option value="futureP">‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (S) ‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (P)</option>
                <option value="presentP">‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (P) ‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (S)</option>
                <option value="findN_P">‡∏´‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (n) ‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô</option>
                <option value="findR_P">‡∏´‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (r) ‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô</option>
            </optgroup>
            <optgroup label="‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏ß‡∏î (Annuity)">
                <option value="futureR_end">‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ù‡∏≤‡∏Å‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠-‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏ß‡∏î)</option>
                <option value="futureR_start">‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ù‡∏≤‡∏Å‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠-‡∏ï‡πâ‡∏ô‡∏á‡∏ß‡∏î)</option>
                <option value="findR_end">‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î (R) - ‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏ß‡∏î</option>
                <option value="findR_start">‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î (R) - ‡∏ï‡πâ‡∏ô‡∏á‡∏ß‡∏î</option>
                <option value="findN_R_end">‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î (n) - ‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏ß‡∏î</option>
                <option value="findN_R_start">‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î (n) - ‡∏ï‡πâ‡∏ô‡∏á‡∏ß‡∏î</option>
            </optgroup>
          </select>
        </div>

        <div class="full" style="display:flex;gap:12px;">
            <div style="flex:1">
                <label for="period">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</label>
                <select id="period">
                  <option value="year" selected>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ (% per Year)</option>
                  <option value="month">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (% per Month)</option>
                </select>
            </div>
            <div id="boxK" style="flex:1">
                 <label for="k">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ï‡πâ‡∏ô (Compounding)</label>
                 <select id="k">
                    <option value="12" selected>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (12 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)</option>
                    <option value="1">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)</option>
                    <option value="4">‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ (4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)</option>
                    <option value="2">‡∏£‡∏≤‡∏¢‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏õ‡∏µ (2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)</option>
                    <option value="365">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (365 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)</option>
                 </select>
            </div>
        </div>

        <div id="boxP" class="full">
          <label id="labelP" for="P">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (P)</label>
          <input id="P" type="number" step="0.01" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
        </div>

        <div id="boxR">
          <label for="r">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (%)</label>
          <input id="r" type="number" step="0.0001" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5 ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á 5%">
        </div>

        <div id="boxN">
          <label for="n">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏õ‡∏µ)</label>
          <input id="n" type="number" step="0.01" min="0" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ">
        </div>

        <div id="boxS">
          <label for="S">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢/‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (S)</label>
          <input id="S" type="number" step="0.01" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
        </div>

        <div class="full">
          <label for="D">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå/‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (D) <span class="hint">(‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏±‡∏Å‡∏•‡∏ö‡∏ï‡∏≠‡∏ô‡∏ó‡πâ‡∏≤‡∏¢)</span></label>
          <input id="D" type="number" step="0.01" placeholder="‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß">
        </div>

        <div class="full btn-group">
          <button class="primary" id="calcBtn" onclick="onCalculate()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button class="secondary" onclick="copyLatest()" id="copyBtn">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ú‡∏•</button>
          <div style="flex:1"></div>
          <button class="secondary" onclick="exportJSON()">Backup</button>
          <button class="secondary" onclick="document.getElementById('fileImport').click()">Restore</button>
          <input type="file" id="fileImport" style="display:none" onchange="importJSON(this)" accept="application/json">
          <button class="danger" onclick="clearAll()">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div class="full">
            <div id="output" class="result-box" style="display:none;"></div>

            <div id="postTools" style="display:none;margin-top:15px;">
              <div class="tools">
                <button class="secondary" onclick="showSchedule()">‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</button>
                <button class="secondary" onclick="downloadScheduleCSV()">‚¨áCSV</button>
                <button class="secondary" onclick="toggleChart()">‡∏Å‡∏£‡∏≤‡∏ü</button>
              </div>
            </div>

            <div id="scheduleArea" style="display:none;margin-top:15px;">
              <div id="scheduleWrap" class="schedule-wrap"></div>
            </div>

            <div id="chartArea" style="display:none;margin-top:15px;">
              <canvas id="chartCanvas"></canvas>
            </div>
        </div>

        <div class="full">
          <div style="border-top:1px solid #e2e8f0; margin:24px 0;"></div>
          <h2 style="font-size:18px; margin-bottom:15px; color:#475569;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h2>
          <div id="summary" class="summary"></div>
          <div id="entries" class="entries"></div>
        </div>

      </div> 
    </div>
  </div>

<script>
/* ================= utility ================= */
const el = id => document.getElementById(id);
const fmt = x => {
  if (!isFinite(x)) return String(x);
  return Number(x).toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2});
};
function escapeHtml(unsafe) {
  if (!unsafe) return '';
  return String(unsafe).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

let entries = JSON.parse(localStorage.getItem('inv_entries_v2') || '[]');
let editingIndex = -1;

const config = {
  futureP:['boxP','boxR','boxN','boxK'],
  presentP:['boxR','boxN','boxS','boxK'],
  findN_P:['boxP','boxR','boxS','boxK'],
  findR_P:['boxP','boxN','boxS','boxK'],
  futureR_end:['boxP','boxR','boxN','boxK'],
  futureR_start:['boxP','boxR','boxN','boxK'],
  findR_end:['boxR','boxN','boxS','boxK'],
  findR_start:['boxR','boxN','boxS','boxK'],
  findN_R_end:['boxP','boxR','boxS','boxK'],
  findN_R_start:['boxP','boxR','boxS','boxK']
};

function updateInputs(){
  const m = el('mode').value;
  ['boxP','boxR','boxN','boxS','boxK'].forEach(b => { el(b).style.display = 'none'; });
  (config[m] || []).forEach(b => el(b).style.display = 'block');
  
  if (m.includes('R') && !m.startsWith('findR_P') && !m.startsWith('findN_P')) {
     el('labelP').innerHTML = '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î (R)'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Label ‡πÄ‡∏õ‡πá‡∏ô R
     el('P').placeholder = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏Å‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠';
  } else {
     el('labelP').innerHTML = '‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (P)';
     el('P').placeholder = '‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏£‡∏Å';
  }
  
  el('output').style.display = 'none';
  el('postTools').style.display = 'none';
  el('scheduleArea').style.display = 'none';
  el('chartArea').style.display = 'none';
  el('scheduleWrap').innerHTML = '';
  clearCanvas();
}

window.addEventListener('load', () => { updateInputs(); renderEntries(); });

function parseEffectiveRate(raw, periodType){
  if (isNaN(raw)) return NaN;
  if (periodType === 'month') return raw * 12;
  return raw; 
}

/* ============== storage & IO ============== */
function saveEntries(){ localStorage.setItem('inv_entries_v2', JSON.stringify(entries)); }
function clearAll(){ if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return; entries=[]; saveEntries(); renderEntries(); el('output').style.display='none'; el('postTools').style.display='none'; }

function exportJSON(){
    const blob = new Blob([JSON.stringify(entries,null,2)],{type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `investment_data_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click();
    setTimeout(()=> { URL.revokeObjectURL(a.href); a.remove(); }, 1500);
}

function importJSON(input){
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
        try {
            const data = JSON.parse(e.target.result);
            if(Array.isArray(data)){
                if(confirm(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)){
                    entries = [...entries, ...data];
                    saveEntries();
                    renderEntries();
                    alert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
            } else { alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
        } catch(err){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢'); }
    };
    reader.readAsText(file);
    input.value = ''; 
}

/* ============== calc logic ============== */
function onCalculate(){
  const resObj = calculate(true);
  if (!resObj) return;

  const name = el('entryName').value.trim() || `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ #${entries.length+1}`;
  const modeLabel = el('mode').options[el('mode').selectedIndex].text;
  
  const payload = {
    name, 
    mode: el('mode').value, 
    modeLabel,
    inputs: { 
        P: el('P').value, 
        r: el('r').value, 
        n: el('n').value, 
        S: el('S').value, 
        D: el('D').value, 
        k: el('k').value,
        periodType: el('period').value 
    },
    created: new Date().toISOString(), 
    text: resObj.text, 
    numeric: resObj.numeric
  };
  
  if (editingIndex >= 0){ 
      entries[editingIndex] = payload; 
      editingIndex = -1; 
      el('calcBtn').innerHTML = ' ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; 
      el('calcBtn').classList.remove('success'); 
      el('calcBtn').classList.add('primary'); 
  } else {
      entries.push(payload);
  }
  
  saveEntries(); 
  renderEntries();
  el('output').style.display='block';
  el('postTools').style.display = 'block';
  setTimeout(() => el('output').scrollIntoView({behavior:'smooth', block:'center'}), 100);
}

function calculate(returnResult=false){
  const mode = el('mode').value;
  const P = parseFloat(el('P').value);
  let rawR = parseFloat(el('r').value);
  const n = parseFloat(el('n').value);
  const S = parseFloat(el('S').value);
  const D = parseFloat(el('D').value) || 0;
  const kInput = parseFloat(el('k').value);
  const k = (isNaN(kInput) || kInput <= 0) ? 12 : kInput;
  const periodType = el('period').value;

  const annualRVal = parseEffectiveRate(rawR, periodType);
  const annualR = (annualRVal > 0) ? annualRVal / 100 : 0;

  const need = config[mode] || [];
  let missing = [];
  if (need.includes('boxP') && isNaN(P)) missing.push('‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô/‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î (P ‡∏´‡∏£‡∏∑‡∏≠ R)');
  if (need.includes('boxR') && isNaN(rawR)) missing.push('‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (r)');
  if (need.includes('boxN') && isNaN(n)) missing.push('‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (n)');
  if (need.includes('boxS') && isNaN(S)) missing.push('‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (S)');
  
  if (missing.length){ 
    el('output').style.display='block'; 
    el('output').innerHTML = `<div class="error"> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å: ${missing.join(', ')}</div>`; 
    return null; 
  }

  let out = ''; 
  let numeric = NaN;
  let formula = '';
  let subst = ''; 
  
  const i_txt = "r/k"; 
  const N_txt = "kn";
  
  const per = (annualR && k>0) ? (annualR / k) : 0;
  const periods = (k * (isFinite(n) ? n : 0));
  
  const sP = fmt(P);
  const sS = fmt(S);
  const sPer = per.toFixed(5); 
  const sN = periods.toFixed(0);

  if (mode === 'futureP'){
    const Sres = (per === 0) ? P : P * Math.pow(1 + per, periods);
    out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (S): ${fmt(Sres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô ${sP} ‡∏ö‡∏≤‡∏ó ‡∏ô‡∏≤‡∏ô ${n} ‡∏õ‡∏µ)\n‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${fmt(Sres - P)}`;
    numeric = Sres - D;
    formula = `S = P √ó (1 + ${i_txt})<sup>${N_txt}</sup>`;
    subst = `S = ${sP} √ó (1 + ${sPer})<sup>${sN}</sup>`;
  
  } else if (mode === 'presentP'){
    const Pres = (per === 0) ? S : S / Math.pow(1 + per, periods);
    out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ (P): ${fmt(Pres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ${sS} ‡πÉ‡∏ô ${n} ‡∏õ‡∏µ)`;
    numeric = Pres - D;
    formula = `P = S / (1 + ${i_txt})<sup>${N_txt}</sup>`;
    subst = `P = ${sS} / (1 + ${sPer})<sup>${sN}</sup>`;

  } else if (mode === 'findN_P'){
    if (per === 0) out = `<div class="error">‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ > 0</div>`;
    else if (P <= 0 || S <= 0 || S <= P) out = `<div class="error">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (S) ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (P)</div>`;
    else { 
        const nres = Math.log(S / P) / (k * Math.log(1 + per)); 
        out = `<strong> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: ${nres.toFixed(2)} ‡∏õ‡∏µ</strong>\n(${(nres*12).toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)`; 
        numeric = nres; 
        formula = `n = log(S / P) / [ k √ó log(1 + ${i_txt}) ]`;
        subst = `n = log(${sS} / ${sP}) / [ ${k} √ó log(1 + ${sPer}) ]`;
    }

  } else if (mode === 'findR_P'){
    if (P <= 0 || S <= 0) out = `<div class="error">P ‡πÅ‡∏•‡∏∞ S ‡∏ï‡πâ‡∏≠‡∏á > 0</div>`;
    else { 
        const base = Math.pow(S/P, 1/(k*n)); 
        const rres = k*(base-1); 
        out = `<strong> ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢: ${(rres*100).toFixed(4)} % ‡∏ï‡πà‡∏≠‡∏õ‡∏µ</strong>`; 
        numeric = rres;
        formula = `r = k √ó [ (S / P)<sup>1/${N_txt}</sup> - 1 ]`;
        subst = `r = ${k} √ó [ (${sS} / ${sP})<sup>1/${sN}</sup> - 1 ]`;
    }

  } else if (mode === 'futureR_end'){
    // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PMT ‡πÄ‡∏õ‡πá‡∏ô R ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
    const Sres = (per === 0) ? P*periods : P * ((Math.pow(1 + per, periods) - 1) / per);
    const totalP = P * periods;
    out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (S): ${fmt(Sres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡∏ù‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ ${sP} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${n} ‡∏õ‡∏µ)`;
    numeric = Sres - D;
    formula = `S = R √ó [ ((1 + ${i_txt})<sup>${N_txt}</sup> - 1) / (${i_txt}) ]`;
    subst = `S = ${sP} √ó [ ((1 + ${sPer})<sup>${sN}</sup> - 1) / ${sPer} ]`;

  } else if (mode === 'futureR_start'){
    // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PMT ‡πÄ‡∏õ‡πá‡∏ô R ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
    const factor = (per === 0) ? periods : ((Math.pow(1 + per, periods) - 1) / per) * (1+per);
    const Sres = P * factor;
    out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (S): ${fmt(Sres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡∏ù‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏á‡∏ß‡∏î ${sP} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${n} ‡∏õ‡∏µ)`;
    numeric = Sres - D;
    formula = `S = R √ó [ ((1 + ${i_txt})<sup>${N_txt}</sup> - 1) / (${i_txt}) ] √ó (1 + ${i_txt})`;
    subst = `S = ${sP} √ó [ ((1 + ${sPer})<sup>${sN}</sup> - 1) / ${sPer} ] √ó (1 + ${sPer})`;

  } else if (mode === 'findR_end'){
    // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PMT ‡πÄ‡∏õ‡πá‡∏ô R ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
    if (per === 0) { const Rres = S/periods; out = `<strong> ‡∏≠‡∏≠‡∏°‡∏á‡∏ß‡∏î‡∏•‡∏∞: ${fmt(Rres)} ‡∏ö‡∏≤‡∏ó</strong>`; numeric = Rres; }
    else { 
        const denom = ((Math.pow(1 + per, periods) - 1) / per); 
        if (denom===0) out = `<div class="error">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>`; 
        else { 
            const Rres = S/denom; 
            out = `<strong>üíµ ‡∏≠‡∏≠‡∏°‡∏á‡∏ß‡∏î‡∏•‡∏∞: ${fmt(Rres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ${sS} ‡πÉ‡∏ô ${n} ‡∏õ‡∏µ)`; 
            numeric = Rres; 
            formula = `R = S / [ ((1 + ${i_txt})<sup>${N_txt}</sup> - 1) / (${i_txt}) ]`;
            subst = `R = ${sS} / [ ((1 + ${sPer})<sup>${sN}</sup> - 1) / ${sPer} ]`;
        } 
    }

  } else if (mode === 'findR_start'){
    // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PMT ‡πÄ‡∏õ‡πá‡∏ô R ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
    if (per === 0) { const Rres = S/periods; out = `<strong> ‡∏≠‡∏≠‡∏°‡∏á‡∏ß‡∏î‡∏•‡∏∞: ${fmt(Rres)} ‡∏ö‡∏≤‡∏ó</strong>`; numeric = Rres; }
    else { 
        const denom = ((Math.pow(1 + per, periods) - 1) / per) * (1 + per); 
        if (denom===0) out = `<div class="error">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>`; 
        else { 
            const Rres = S/denom; 
            out = `<strong>üíµ ‡∏≠‡∏≠‡∏°‡∏á‡∏ß‡∏î‡∏•‡∏∞: ${fmt(Rres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡πÅ‡∏ö‡∏ö‡∏ù‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏á‡∏ß‡∏î)`; 
            numeric = Rres; 
            formula = `R = S / [ (((1 + ${i_txt})<sup>${N_txt}</sup> - 1) / ${i_txt}) √ó (1 + ${i_txt}) ]`;
            subst = `R = ${sS} / [ (((1 + ${sPer})<sup>${sN}</sup> - 1) / ${sPer}) √ó (1 + ${sPer}) ]`;
        } 
    }

  } else if (mode === 'findN_R_end'){
    const R_val = P; 
    if(R_val <= 0) out = `<div class="error">‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (R) ‡∏ï‡πâ‡∏≠‡∏á > 0</div>`;
    else {
      if(per === 0){ const nres = S / R_val / k; out = `<strong> ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${nres.toFixed(2)} ‡∏õ‡∏µ</strong>`; numeric = nres; }
      else {
        const num = 1 + (S*per)/R_val;
        if (num <= 0) out = `<div class="error">‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•</div>`;
        else { 
            const N = Math.log(num) / Math.log(1+per); 
            const nres = N / k; 
            out = `<strong> ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${nres.toFixed(2)} ‡∏õ‡∏µ</strong>\n(‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${Math.ceil(N)} ‡∏á‡∏ß‡∏î)`; 
            numeric = nres; 
            // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PMT ‡πÄ‡∏õ‡πá‡∏ô R ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
            formula = `n = log(1 + (S √ó ${i_txt}) / R) / [ k √ó log(1 + ${i_txt}) ]`;
            subst = `n = log(1 + (${sS} √ó ${sPer}) / ${sP}) / [ ${k} √ó log(1 + ${sPer}) ]`;
        }
      }
    }

  } else if (mode === 'findN_R_start'){
    const R_val = P;
    if(R_val <= 0) out = `<div class="error">‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (R) ‡∏ï‡πâ‡∏≠‡∏á > 0</div>`;
    else {
      if(per === 0){ const nres = S / R_val / k; out = `<strong> ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${nres.toFixed(2)} ‡∏õ‡∏µ</strong>`; numeric = nres; }
      else {
        const num = 1 + (S*per)/(R_val*(1+per));
        if (num <= 0) out = `<div class="error">‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•</div>`;
        else { 
            const N = Math.log(num) / Math.log(1+per); 
            const nres = N / k; 
            out = `<strong> ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${nres.toFixed(2)} ‡∏õ‡∏µ</strong>\n(‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${Math.ceil(N)} ‡∏á‡∏ß‡∏î)`; 
            numeric = nres; 
            // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PMT ‡πÄ‡∏õ‡πá‡∏ô R ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
            formula = `n = log(1 + (S √ó ${i_txt}) / (R(1+${i_txt}))) / [ k √ó log(1 + ${i_txt}) ]`;
            subst = `n = log(1 + (${sS} √ó ${sPer}) / (${sP}(1+${sPer}))) / [ ${k} √ó log(1 + ${sPer}) ]`;
        }
      }
    }
  } else {
    out = '<div class="error">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö</div>';
  }

  // Final rendering
  let finalText = out.replace(/\n/g,'<br>');
  if(formula && !out.includes('error')) {
      finalText += `
        <div class="math-box">
           <div class="math-section">
             <span class="math-label"> ‡∏™‡∏π‡∏ï‡∏£ (Formula):</span>
             <span class="math-code">${formula}</span>
           </div>
           <div class="math-section">
             <span class="math-label"> ‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤ (Substitution):</span>
             <span class="math-code math-hl">${subst}</span>
           </div>
        </div>
      `;
  }
  
  el('output').innerHTML = `<div style="line-height:1.6">${finalText}</div>`;
  el('postTools').style.display = finalText ? 'block' : 'none';
  if (returnResult) return { text: out.replace(/<[^>]*>?/gm, ''), numeric: (isFinite(numeric) ? numeric : NaN) };
  return null;
}

/* ============== entries UI ============== */
function renderEntries(){
  const container = el('entries'); container.innerHTML = '';
  if(entries.length === 0) container.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>';
  entries.slice().reverse().forEach((it, idx) => {
    const realIdx = entries.length - 1 - idx;
    const div = document.createElement('div'); div.className='entry';
    div.innerHTML = `
        <div class="entry-header">
            <div>
                <h3>${escapeHtml(it.name)}</h3>
                <div class="meta">${escapeHtml(it.modeLabel)} ¬∑ ${new Date(it.created).toLocaleString('th-TH')}</div>
            </div>
            <div class="badge">${isFinite(it.numeric) ? fmt(it.numeric) : 'N/A'}</div>
        </div>
        <div class="entry-content">${escapeHtml(it.text)}</div>
        <div class="entry-actions">
            <button class="secondary" onclick="loadToForm(${realIdx})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="danger" onclick="deleteEntry(${realIdx})">‡∏•‡∏ö</button>
        </div>
    `;
    container.appendChild(div);
  });
  renderSummary();
}

function deleteEntry(index){ if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return; entries.splice(index,1); saveEntries(); renderEntries(); }
function loadToForm(index){
  const it = entries[index];
  el('entryName').value = it.name || '';
  el('mode').value = it.mode;
  updateInputs();
  if(it.inputs.k) el('k').value = it.inputs.k;
  el('period').value = it.inputs.periodType || 'year';
  
  el('P').value = it.inputs.P || '';
  el('r').value = it.inputs.r || '';
  el('n').value = it.inputs.n || '';
  el('S').value = it.inputs.S || '';
  el('D').value = it.inputs.D || '';
  editingIndex = index;
  el('calcBtn').innerHTML = ' ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
  el('calcBtn').classList.remove('primary');
  el('calcBtn').classList.add('success');
  window.scrollTo({top:0,behavior:'smooth'});
}

function renderSummary(){
  const s = el('summary'); s.innerHTML = '';
  if (entries.length < 2) return;
  const validFV = entries.filter(e => e.mode.includes('future') || e.mode.includes('present'));
  if(validFV.length > 0){
      const maxVal = validFV.reduce((prev, current) => {
        const a = isFinite(prev.numeric) ? prev.numeric : -Infinity;
        const b = isFinite(current.numeric) ? current.numeric : -Infinity;
        return (a > b) ? prev : current;
      });
      if (isFinite(maxVal.numeric)) {
        s.innerHTML = `<div class="sumitem" style="border-left:4px solid var(--success);padding:10px;background:#fff;border-radius:8px;box-shadow:0 1px 2px rgba(0,0,0,0.05)">
          <div style="font-weight:bold;color:var(--success)">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
          <div style="font-size:0.9em;color:#64748b">${escapeHtml(maxVal.name)}</div>
          <div style="font-size:1.3em;font-weight:600;margin-top:4px">${fmt(maxVal.numeric)}</div>
        </div>`;
      }
  }
}

/* ============== Schedule & Chart ============== */
function buildScheduleFromForm(){
  const mode = el('mode').value;
  const P = parseFloat(el('P').value);
  const rawR = parseFloat(el('r').value);
  const n = parseFloat(el('n').value);
  const kInput = parseFloat(el('k').value);
  const k = (isNaN(kInput) || kInput <= 0) ? 12 : kInput;
  const periodType = el('period').value;

  const annualRVal = parseEffectiveRate(rawR, periodType);
  const annualR = (annualRVal > 0) ? annualRVal / 100 : 0;
  
  const per = (annualR && k>0) ? (annualR / k) : 0;
  const periods = Math.round(k * (isFinite(n) ? n : 0));

  const MAX_ROWS = 600;
  if (periods > MAX_ROWS) {
    if (!confirm(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î = ${periods} (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ ${MAX_ROWS})\n‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà ${MAX_ROWS} ‡∏á‡∏ß‡∏î\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return null;
  }
  const capPeriods = Math.min(periods, MAX_ROWS);
  if (capPeriods <= 0) return null;

  let rows = [];
  let R_val = 0; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢
  let balance = 0;

  if (mode.startsWith('futureP') || mode.startsWith('presentP') || mode.startsWith('findN_P') || mode.startsWith('findR_P')) {
    balance = isFinite(P) ? P : 0;
    rows.push({period:0, balanceBefore:balance, interest:0, payment:0, balanceAfter:balance});
    for (let i=1;i<=capPeriods;i++){
      const interest = balance * per;
      const after = balance + interest;
      rows.push({period:i, balanceBefore:balance, interest, payment:0, balanceAfter:after});
      balance = after;
    }
  } else {
    const calcRes = calculate(true); 
    if (mode.includes('findR')) {
        R_val = calcRes && isFinite(calcRes.numeric) ? calcRes.numeric : 0;
    } else {
        R_val = isFinite(P) ? P : 0;
    }
    if (mode === 'futureR_end' || mode === 'futureR_start') balance = 0; 

    rows.push({period:0, balanceBefore:balance, interest:0, payment:0, balanceAfter:balance});
    for (let i=1;i<=capPeriods;i++){
       if (mode === 'futureR_start' || mode === 'findR_start') {
         const mid = balance + R_val;
         const interest = mid * per;
         const after = mid + interest;
         rows.push({period:i, balanceBefore:balance, interest, payment:R_val, balanceAfter:after});
         balance = after;
       } else {
         const interest = balance * per;
         const after = balance + interest + R_val;
         rows.push({period:i, balanceBefore:balance, interest, payment:R_val, balanceAfter:after});
         balance = after;
       }
    }
  }
  return {rows, periods, cap: capPeriods};
}

function showSchedule(){
  const scheduleData = buildScheduleFromForm();
  if (!scheduleData) return;
  const {rows, periods, cap} = scheduleData;
  const wrap = el('scheduleWrap'); wrap.innerHTML = '';
  if (periods > cap) {
    wrap.innerHTML += `<div class="warn"> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${cap} ‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å (‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${periods}) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</div>`;
  }
  let html = `<div style="overflow:auto;max-height:400px;"><table><thead><tr><th>‡∏á‡∏ß‡∏î</th><th>‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏á‡∏ß‡∏î</th><th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th><th>‡∏ù‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° (R)</th><th>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th></tr></thead><tbody>`;
  rows.forEach(r => {
    html += `<tr>
      <td style="text-align:center">${r.period}</td>
      <td>${fmt(r.balanceBefore)}</td>
      <td style="color:${r.interest>0?'#059669':'inherit'}">${fmt(r.interest)}</td>
      <td style="color:${r.payment>0?'#2563eb':'inherit'}">${fmt(r.payment)}</td>
      <td style="font-weight:600">${fmt(r.balanceAfter)}</td>
    </tr>`;
  });
  html += `</tbody></table></div>`;
  wrap.innerHTML += html;
  el('scheduleArea').style.display = 'block';
  window._lastSchedule = rows;
  
  drawChartFromRows(rows);
  el('chartArea').style.display = 'block';
  el('scheduleArea').scrollIntoView({behavior:'smooth', block:'nearest'});
}

function downloadScheduleCSV(){
  if(!window._lastSchedule || window._lastSchedule.length===0){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï" ‡∏Å‡πà‡∏≠‡∏ô'); return; }
  const rows = window._lastSchedule;
  let csv = 'period,balanceBefore,interest,payment_R,balanceAfter\n';
  rows.forEach(r => csv += `${r.period},${(r.balanceBefore||0).toFixed(4)},${(r.interest||0).toFixed(4)},${(r.payment||0).toFixed(4)},${(r.balanceAfter||0).toFixed(4)}\n`);
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `schedule_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },1500);
}

function copyLatest(){
  if (entries.length === 0) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'); return; }
  const last = entries[entries.length-1];
  navigator.clipboard?.writeText(last.text).then(()=> alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'), ()=> alert('Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'));
}

/* ================= CHART ================= */
const canvas = el('chartCanvas');
let ctx = canvas.getContext ? canvas.getContext('2d') : null;
function clearCanvas(){ if(!ctx) ctx = canvas.getContext('2d'); ctx && ctx.clearRect(0,0,canvas.width,canvas.height); }

function resizeCanvasToDisplaySize(canvas) {
  const ratio = window.devicePixelRatio || 1;
  const width = canvas.clientWidth * ratio;
  const height = canvas.clientHeight * ratio;
  if (canvas.width !== width || canvas.height !== height) {
    canvas.width = width; canvas.height = height;
    return true;
  }
  return false;
}

function drawChartFromRows(rows){
  if(!ctx) ctx = canvas.getContext('2d');
  resizeCanvasToDisplaySize(canvas);
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);
  
  if(!rows || rows.length===0) return;
  const data = rows.map(r => r.balanceAfter);
  const labels = rows.map(r => r.period);

  const padTop = 40, padBot = 40, padLeft = 60, padRight = 20;
  const chartH = h - padTop - padBot;
  const chartW = w - padLeft - padRight;

  const minY = Math.min(0, ...data); 
  const maxY = Math.max(...data);
  const rangeY = (maxY - minY) || 1;

  // Grid
  ctx.strokeStyle = '#f1f5f9'; ctx.lineWidth = 1;
  const gridLines = 5;
  for (let i=0;i<=gridLines;i++){
    const y = padTop + chartH * (i / gridLines);
    ctx.beginPath(); ctx.moveTo(padLeft, y); ctx.lineTo(w - padRight, y); ctx.stroke();
    const val = maxY - (rangeY * (i/gridLines));
    ctx.fillStyle = '#94a3b8'; ctx.font = '12px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(Number(val).toLocaleString('en',{maximumFractionDigits:0}), padLeft - 10, y + 4);
  }

  // Draw Area
  const getX = (i) => padLeft + (chartW * (i / (data.length - 1)));
  const getY = (val) => padTop + chartH * (1 - (val - minY) / rangeY);

  const grad = ctx.createLinearGradient(0, padTop, 0, h - padBot);
  grad.addColorStop(0, 'rgba(59, 130, 246, 0.2)'); 
  grad.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

  ctx.beginPath();
  ctx.moveTo(getX(0), h - padBot); 
  data.forEach((val, i) => { ctx.lineTo(getX(i), getY(val)); });
  ctx.lineTo(getX(data.length-1), h - padBot); 
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Draw Line
  ctx.beginPath();
  ctx.lineWidth = 3;
  ctx.strokeStyle = '#3b82f6';
  ctx.lineJoin = 'round';
  data.forEach((val, i) => {
    if(i===0) ctx.moveTo(getX(i), getY(val));
    else ctx.lineTo(getX(i), getY(val));
  });
  ctx.stroke();

  // End Point
  const lastX = getX(data.length-1);
  const lastY = getY(data[data.length-1]);
  ctx.beginPath(); ctx.arc(lastX, lastY, 6, 0, Math.PI*2);
  ctx.fillStyle = '#fff'; ctx.fill();
  ctx.lineWidth = 2; ctx.stroke();

  ctx.fillStyle = '#64748b'; ctx.textAlign = 'center';
  ctx.fillText('Start', padLeft, h - 10);
  ctx.fillText(`End`, w - padRight - 10, h - 10);
}

function toggleChart(){
  const area = el('chartArea');
  const isHidden = (area.style.display === 'none' || area.style.display === '');
  area.style.display = isHidden ? 'block' : 'none';
  if(isHidden && window._lastSchedule) {
      drawChartFromRows(window._lastSchedule);
      area.scrollIntoView({behavior:'smooth', block:'center'});
  }
}
</script>
</body>
</html>