<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<title>‡πÄ‡πÄ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f8fafc;--card:#ffffff;--accent:#3b82f6;--accent-hover:#2563eb;--muted:#64748b;--border:#e2e8f0;--danger:#ef4444;--success:#10b981;}
  body{font-family:'Kanit',sans-serif;background:var(--bg);margin:0;padding:20px;display:flex;justify-content:center;color:#334155;line-height:1.5;}
  .wrap{max-width:900px;width:100%}
  h1{color:#1e293b;margin:0 0 20px;text-align:center;font-weight:600;}
  .card{background:var(--card);padding:24px;border-radius:20px;box-shadow:0 10px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.01);}
  
  .grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:16px;}
  .full{grid-column:1/ -1;}

  label{font-weight:500;display:block;margin-bottom:6px;color:#475569;font-size:14px;}
  input,select,button{font-family:'Kanit',sans-serif;}
  input,select{width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--border);font-size:15px;box-sizing:border-box;transition:all 0.2s;background:#fff;}
  input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.15);}
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  
  .hint{font-size:0.85em;color:var(--muted);margin-left:4px;}

  .btn-group{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;}
  button{padding:10px 16px;border-radius:10px;border:none;font-size:15px;cursor:pointer;font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;justify-content:center;gap:6px;}
  button.primary{background:var(--accent);color:#fff;box-shadow:0 4px 6px -1px rgba(59,130,246,0.2);}
  button.primary:hover{background:var(--accent-hover);transform:translateY(-1px);}
  button.secondary{background:#fff;border:1px solid var(--border);color:#475569;}
  button.secondary:hover{background:#f1f5f9;border-color:#cbd5e1;}
  button.danger{background:#fff;border:1px solid var(--danger);color:var(--danger);}
  button.danger:hover{background:#fef2f2;}
  button.success{background:var(--success);color:#fff;}
  
  .result-box{background:linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);border:1px solid #bfdbfe;padding:20px;border-radius:12px;margin-top:20px;animation:fadeIn 0.3s ease;}
  .error{color:#b91c1c;font-weight:500;padding:12px;background:#fef2f2;border-radius:8px;border:1px solid #fecaca;}

  /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤ */
  .math-box {
    background: #f8fafc;
    border: 1px solid #cbd5e1;
    border-left: 5px solid #3b82f6;
    padding: 15px;
    margin-top: 20px;
    border-radius: 6px;
    font-size: 0.95em;
  }
  .math-section { margin-bottom: 12px; }
  .math-section:last-child { margin-bottom: 0; }
  .math-label { font-weight: 600; color: #475569; margin-bottom: 4px; display: block; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
  .math-code { 
    font-family: 'Courier New', monospace; 
    color: #334155; 
    background: #fff;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    display: block;
    overflow-x: auto;
  }
  .math-hl { color: #2563eb; font-weight: bold; }

  .entries{display:flex;flex-direction:column;gap:12px;margin-top:16px;}
  .entry{background:#fff;padding:16px;border-radius:12px;border:1px solid var(--border);display:flex;flex-direction:column;gap:10px;position:relative;overflow:hidden;}
  .entry-header{display:flex;justify-content:space-between;align-items:flex-start;}
  .entry h3{margin:0;font-size:16px;color:#1e293b;font-weight:600;}
  .entry .meta{color:var(--muted);font-size:13px;margin-top:2px;}
  .entry-content{background:#f8fafc;padding:10px;border-radius:6px;font-family:monospace;font-size:13px;white-space:pre-wrap;color:#475569;}
  .entry-actions{display:flex;gap:8px;justify-content:flex-end;}
  .badge{display:inline-block;padding:4px 10px;border-radius:20px;background:#e0f2fe;color:#0369a1;font-weight:600;font-size:13px;}

  .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
  .schedule-wrap{margin-top:12px;background:#fff;border:1px solid var(--border);padding:0;border-radius:10px;overflow:hidden;}
  table{width:100%;border-collapse:collapse;font-size:13px;}
  th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:right;}
  th{background:#f8fafc;text-align:center;font-weight:600;color:#64748b;}
  
  /* Canvas ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á */
  canvas{width:100% !important; height:350px !important; border-radius:12px; margin-top:10px; background:#fff; border:1px solid var(--border);}
  
  @keyframes fadeIn { from{opacity:0;transform:translateY(5px);} to{opacity:1;transform:translateY(0);} }
  @media (max-width:760px){
    .grid{grid-template-columns:1fr;}
    .btn-group{flex-direction:column;align-items:stretch;}
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<nav>
    <div class="nav-logo" style="padding: 10px 20px; font-weight:bold; font-size:1.2em;"></div>
</nav>
<body>
  <div class="wrap" role="main">
    <h1>‡πÄ‡πÄ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</h1>
    <div class="card">
      <div class="grid">
        
        <div class="full">
          <label for="entryName"> ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Optional)</label>
          <input id="entryName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ú‡∏ô‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì, ‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏ñ, ‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ">
        </div>

        <div class="full">
          <label for="mode"> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</label>
          <select id="mode" onchange="updateInputs()">
            <optgroup label="‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß">
                <option value="futureP">‡∏´‡∏≤‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (S)</option>
                <option value="presentP">‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ (P)</option>
                <option value="findN_P">‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ (n)</option>
                <option value="findR_P">‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (r)</option>
            </optgroup>
            <optgroup label="‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏ß‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô">
                <option value="futureR_end">‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ù‡∏≤‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏ß‡∏î)</option>
                <option value="futureR_start">‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ù‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏á‡∏ß‡∏î)</option>
                <option value="findR_end">‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î (‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏ß‡∏î)</option>
                <option value="findR_start">‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î (‡∏ï‡πâ‡∏ô‡∏á‡∏ß‡∏î)</option>
                <option value="findN_R_end">‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î (‡∏ù‡∏≤‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏ß‡∏î)</option>
                <option value="findN_R_start">‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î (‡∏ù‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏á‡∏ß‡∏î)</option>
            </optgroup>
            <optgroup label="‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î">
                <option value="future_gradient">‡∏´‡∏≤‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏ì‡∏¥‡∏ï</option>
                <option value="future_geometric">‡∏´‡∏≤‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï</option>
                <option value="findN_gradient">‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏ì‡∏¥‡∏ï</option>
                <option value="findN_geometric">‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ ‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï</option>
            </optgroup>
          </select>
        </div>

        <div class="full" style="display:flex;gap:12px;">
            <div style="flex:1">
                <label for="period">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</label>
                <select id="period">
                  <option value="year" selected>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ (% per Year)</option>
                  <option value="month">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (% per Month)</option>
                </select>
            </div>
            <div id="boxK" style="flex:1">
                 <label for="k">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ï‡πâ‡∏ô </label>
                 <select id="k">
                    <option value="12" selected>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (12 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)</option>
                    <option value="1">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)</option>
                    <option value="4">‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ (4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)</option>
                    <option value="2">‡∏£‡∏≤‡∏¢‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏õ‡∏µ (2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)</option>
                    <option value="365">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (365 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)</option>
                 </select>
            </div>
        </div>

        <div id="boxP" class="full">
          <label id="labelP" for="P">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (P)</label>
          <input id="P" type="number" step="0.01" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
        </div>

        <div id="boxD" class="full" style="display:none;">
            <label for="D">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î (d)</label>
            <input id="D" type="number" step="0.01" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏á‡∏ß‡∏î">
            <div class="hint">‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô d ‡∏ö‡∏≤‡∏ó</div>
        </div>

        <div id="boxQ" class="full" style="display:none;">
            <label for="Q">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å (g)</label>
            <input id="Q" type="number" step="0.01" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ % ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 3 ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡πÇ‡∏ï 3% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ)">
            <div class="hint">* ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏° q = 1 + (g / 100)</div>
        </div>

        <div id="boxR">
          <label for="r">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (%)</label>
          <input id="r" type="number" step="0.0001" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5 ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á 5%">
        </div>

        <div id="boxN">
          <label for="n">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏õ‡∏µ)</label>
          <input id="n" type="number" step="0.01" min="0" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ">
        </div>

        <div id="boxS">
          <label for="S">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢/‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (S)</label>
          <input id="S" type="number" step="0.01" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
        </div>


        <div class="full btn-group">
          <button class="primary" id="calcBtn" onclick="onCalculate()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button class="secondary" onclick="copyLatest()" id="copyBtn">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ú‡∏•</button>
          <div style="flex:1"></div>
          <button class="secondary" onclick="exportJSON()">Backup</button>
          <button class="secondary" onclick="document.getElementById('fileImport').click()">Restore</button>
          <input type="file" id="fileImport" style="display:none" onchange="importJSON(this)" accept="application/json">
          <button class="danger" onclick="clearAll()">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div class="full">
            <div id="output" class="result-box" style="display:none;"></div>

            <div id="postTools" style="display:none;margin-top:15px;">
              <div class="tools">
                <button class="secondary" onclick="showSchedule()">‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</button>
                <button class="secondary" onclick="downloadScheduleCSV()">‚¨áCSV</button>
                <button class="secondary" onclick="toggleChart()">üìà ‡∏Å‡∏£‡∏≤‡∏ü (Smooth)</button>
              </div>
            </div>

            <div id="scheduleArea" style="display:none;margin-top:15px;">
              <div id="scheduleWrap" class="schedule-wrap"></div>
            </div>

            <div id="chartArea" style="display:none;margin-top:15px;">
              <canvas id="chartCanvas"></canvas>
            </div>
        </div>

        <div class="full">
          <div style="border-top:1px solid #e2e8f0; margin:24px 0;"></div>
          <h2 style="font-size:18px; margin-bottom:15px; color:#475569;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h2>
          <div id="summary" class="summary"></div>
          <div id="entries" class="entries"></div>
        </div>

      </div> 
    </div>
  </div>

<script>
/* ================= utility ================= */
const el = id => document.getElementById(id);
const fmt = x => {
  if (!isFinite(x)) return String(x);
  return Number(x).toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2});
};
function escapeHtml(unsafe) {
  if (!unsafe) return '';
  return String(unsafe).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

let entries = JSON.parse(localStorage.getItem('inv_entries_v2') || '[]');
let editingIndex = -1;
let myChart = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Chart Instance

const config = {
  futureP:['boxP','boxR','boxN','boxK'],
  presentP:['boxR','boxN','boxS','boxK'],
  findN_P:['boxP','boxR','boxS','boxK'],
  findR_P:['boxP','boxN','boxS','boxK'],
  futureR_end:['boxP','boxR','boxN','boxK'],
  futureR_start:['boxP','boxR','boxN','boxK'],
  findR_end:['boxR','boxN','boxS','boxK'],
  findR_start:['boxR','boxN','boxS','boxK'],
  findN_R_end:['boxP','boxR','boxS','boxK'],
  findN_R_start:['boxP','boxR','boxS','boxK'],
  future_gradient:['boxP','boxD','boxR','boxN','boxK'],
  future_geometric:['boxP','boxQ','boxR','boxN','boxK'],
  findN_gradient:['boxP','boxD','boxR','boxS','boxK'],
  findN_geometric:['boxP','boxQ','boxR','boxS','boxK']
};

function updateInputs(){
  const m = el('mode').value;
  ['boxP','boxR','boxN','boxS','boxK','boxD','boxQ'].forEach(b => { el(b).style.display = 'none'; });
  (config[m] || []).forEach(b => el(b).style.display = 'block');
  
  if (m.includes('gradient') || m.includes('geometric')) {
      el('labelP').innerHTML = '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å (a1)';
      el('P').placeholder = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å';
  } else if (m.includes('R') && !m.startsWith('findR_P') && !m.startsWith('findN_P')) {
      el('labelP').innerHTML = '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î (R)';
      el('P').placeholder = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏Å‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠';
  } else {
      el('labelP').innerHTML = '‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (P)';
      el('P').placeholder = '‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏£‡∏Å';
  }
  
  el('output').style.display = 'none';
  el('postTools').style.display = 'none';
  el('scheduleArea').style.display = 'none';
  el('chartArea').style.display = 'none';
  el('scheduleWrap').innerHTML = '';
  clearCanvas();
}

window.addEventListener('load', () => { updateInputs(); renderEntries(); });

function parseEffectiveRate(raw, periodType){
  if (isNaN(raw)) return NaN;
  if (periodType === 'month') return raw * 12;
  return raw; 
}

/* ============== storage & IO ============== */
function saveEntries(){ localStorage.setItem('inv_entries_v2', JSON.stringify(entries)); }
function clearAll(){ if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return; entries=[]; saveEntries(); renderEntries(); el('output').style.display='none'; el('postTools').style.display='none'; }

function exportJSON(){
    const blob = new Blob([JSON.stringify(entries,null,2)],{type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `investment_data_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click();
    setTimeout(()=> { URL.revokeObjectURL(a.href); a.remove(); }, 1500);
}

function importJSON(input){
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
        try {
            const data = JSON.parse(e.target.result);
            if(Array.isArray(data)){
                if(confirm(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)){
                    entries = [...entries, ...data];
                    saveEntries();
                    renderEntries();
                    alert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
            } else { alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
        } catch(err){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢'); }
    };
    reader.readAsText(file);
    input.value = ''; 
}

/* ============== CORE CALC LOGIC (Full Version) ============== */
function onCalculate(){
  const resObj = calculate(true);
  if (!resObj) return;

  const name = el('entryName').value.trim() || `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ #${entries.length+1}`;
  const modeLabel = el('mode').options[el('mode').selectedIndex].text;
  
  const payload = {
    name, 
    mode: el('mode').value, 
    modeLabel,
    inputs: { 
        P: el('P').value, 
        r: el('r').value, 
        n: el('n').value, 
        S: el('S').value, 
        D: el('D').value,
        Q: el('Q').value, 
        k: el('k').value,
        periodType: el('period').value 
    },
    created: new Date().toISOString(), 
    text: resObj.text, 
    numeric: resObj.numeric
  };
  
  if (editingIndex >= 0){ 
      entries[editingIndex] = payload; 
      editingIndex = -1; 
      el('calcBtn').innerHTML = ' ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; 
      el('calcBtn').classList.remove('success'); 
      el('calcBtn').classList.add('primary'); 
  } else {
      entries.push(payload);
  }
  
  saveEntries(); 
  renderEntries();
  el('output').style.display='block';
  el('postTools').style.display = 'block';
  setTimeout(() => el('output').scrollIntoView({behavior:'smooth', block:'center'}), 100);
}

function calculate(returnResult=false){
  const mode = el('mode').value;
  const P = parseFloat(el('P').value); 
  let rawR = parseFloat(el('r').value);
  const n = parseFloat(el('n').value);
  const S = parseFloat(el('S').value);
  const D = parseFloat(el('D').value) || 0; 
  const G = parseFloat(el('Q').value) || 0; 
  const kInput = parseFloat(el('k').value);
  const k = (isNaN(kInput) || kInput <= 0) ? 12 : kInput;
  const periodType = el('period').value;

  const annualRVal = parseEffectiveRate(rawR, periodType);
  const annualR = (annualRVal > 0) ? annualRVal / 100 : 0;

  const need = config[mode] || [];
  let missing = [];
  if (need.includes('boxP') && isNaN(P)) missing.push('‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô/‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å (P/a1)');
  if (need.includes('boxR') && isNaN(rawR)) missing.push('‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (r)');
  if (need.includes('boxN') && isNaN(n)) missing.push('‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (n)');
  if (need.includes('boxS') && isNaN(S)) missing.push('‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (S)');
  if (need.includes('boxD') && isNaN(D)) missing.push('‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î (d)');
  if (need.includes('boxQ') && isNaN(G)) missing.push('‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï (g)');
  
  if (missing.length){ 
    el('output').style.display='block'; 
    el('output').innerHTML = `<div class="error"> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å: ${missing.join(', ')}</div>`; 
    return null; 
  }

  let out = ''; 
  let numeric = NaN;
  let formula = '';
  let subst = ''; 
  
  const per = (annualR && k>0) ? (annualR / k) : 0;
  const periods = (k * (isFinite(n) ? n : 0));
  
  const sP = fmt(P);
  const sS = fmt(S);
  const sD = fmt(D);
  const sPer = per.toFixed(5); 
  const sN = periods.toFixed(0);

  /* Logic Calculation - Full Version Restored */
  if (mode === 'future_geometric') {
      const q = 1 + (G/100);
      const sQ = q.toFixed(4);
      let Fv = 0;
      if (Math.abs((1+per) - q) < 0.0000001) {
          Fv = periods * P * Math.pow(1+per, periods-1);
          out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Fv): ${fmt(Fv)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ = ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï)`;
          formula = `Fv = n √ó a1 √ó (1 + r)<sup>n-1</sup>`;
          subst = `Fv = ${sN} √ó ${sP} √ó (1 + ${sPer})<sup>${periods-1}</sup>`;
      } else {
          const numerator = P * (1+per) * (Math.pow(1+per, periods) - Math.pow(q, periods));
          const denominator = (1+per) - q;
          Fv = numerator / denominator;
          out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Fv): ${fmt(Fv)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡πÄ‡∏£‡∏¥‡πà‡∏° ${sP}, ‡πÇ‡∏ï ${G}% ‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î, ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ ${rawR}%)`;
          formula = `Fv = [ a1(1+r) [ (1+r)<sup>n</sup> - q<sup>n</sup> ] ] / (1 + r - q)`;
          subst = `Fv = [ ${sP}(1+${sPer}) [ (1+${sPer})<sup>${sN}</sup> - ${sQ}<sup>${sN}</sup> ] ] / (1 + ${sPer} - ${sQ})`;
      }
      numeric = Fv;

  } else if (mode === 'future_gradient') {
      if (per === 0) {
        const total = (periods/2) * (2*P + (periods-1)*D);
        out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Fv): ${fmt(total)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢)`;
        numeric = total;
        formula = `Fv = (n/2) √ó [ 2a1 + (n-1)d ]`;
        subst = `Fv = (${sN}/2) √ó [ 2(${sP}) + (${sN}-1)${sD} ]`;
      } else {
        const term1_top = P * (1+per) * (Math.pow(1+per, periods) - 1);
        const term1 = term1_top / per;
        const bracket_part1 = ( (1+per)*(Math.pow(1+per, periods) - 1) ) / (per*per);
        const bracket_part2 = ( (1+per)*periods ) / per;
        const term2 = D * (bracket_part1 - bracket_part2);
        const Fv = term1 + term2;
        
        out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Fv): ${fmt(Fv)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡πÄ‡∏£‡∏¥‡πà‡∏° ${sP} ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏á‡∏ß‡∏î‡∏•‡∏∞ ${sD})`;
        numeric = Fv;
        formula = `Fv = [ a1(1+r)((1+r)<sup>n</sup>-1) / r ] + d [ (1+r)((1+r)<sup>n</sup>-1)/r<sup>2</sup> - (1+r)n/r ]`;
        subst = `Fv = ‡∏û‡∏à‡∏ô‡πå‡πÅ‡∏£‡∏Å(${fmt(term1)}) + ‡∏û‡∏à‡∏ô‡πå‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°(${fmt(term2)})`;
      }

  } else if (mode === 'futureP'){
    const Sres = (per === 0) ? P : P * Math.pow(1 + per, periods);
    out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (S): ${fmt(Sres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô ${sP} ‡∏ö‡∏≤‡∏ó ‡∏ô‡∏≤‡∏ô ${n} ‡∏õ‡∏µ)\n‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${fmt(Sres - P)}`;
    numeric = Sres;
    formula = `S = P √ó (1 + r)<sup>n</sup>`;
    subst = `S = ${sP} √ó (1 + ${sPer})<sup>${sN}</sup>`;
  
  } else if (mode === 'presentP'){
    const Pres = (per === 0) ? S : S / Math.pow(1 + per, periods);
    out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ (P): ${fmt(Pres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ${sS} ‡πÉ‡∏ô ${n} ‡∏õ‡∏µ)`;
    numeric = Pres;
    formula = `P = S / (1 + r)<sup>n</sup>`;
    subst = `P = ${sS} / (1 + ${sPer})<sup>${sN}</sup>`;

  } else if (mode === 'findN_P'){
    if (per === 0) out = `<div class="error">‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ > 0</div>`;
    else if (P <= 0 || S <= 0 || S <= P) out = `<div class="error">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (S) ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (P)</div>`;
    else { 
        const nres = Math.log(S / P) / (k * Math.log(1 + per)); 
        out = `<strong> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: ${nres.toFixed(2)} ‡∏õ‡∏µ</strong>\n(${(nres*12).toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)`; 
        numeric = nres; 
        formula = `n(‡∏õ‡∏µ) = log(S / P) / [ k √ó log(1 + r) ]`;
        subst = `n = log(${sS} / ${sP}) / [ ${k} √ó log(1 + ${sPer}) ]`;
    }

  } else if (mode === 'findR_P'){
    if (P <= 0 || S <= 0) out = `<div class="error">P ‡πÅ‡∏•‡∏∞ S ‡∏ï‡πâ‡∏≠‡∏á > 0</div>`;
    else { 
        const base = Math.pow(S/P, 1/(k*n)); 
        const rres = k*(base-1); 
        out = `<strong> ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢: ${(rres*100).toFixed(4)} % ‡∏ï‡πà‡∏≠‡∏õ‡∏µ</strong>`; 
        numeric = rres;
        formula = `rate = k √ó [ (S / P)<sup>1/kn</sup> - 1 ]`;
        subst = `rate = ${k} √ó [ (${sS} / ${sP})<sup>1/${sN}</sup> - 1 ]`;
    }

  } else if (mode === 'futureR_end'){
    const Sres = (per === 0) ? P*periods : P * ((Math.pow(1 + per, periods) - 1) / per);
    const totalPrincipal = P * periods;
    out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (S): ${fmt(Sres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡∏ù‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ ${sP} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${n} ‡∏õ‡∏µ)\n‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏£‡∏ß‡∏°: ${fmt(totalPrincipal)}\n‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°: ${fmt(Sres - totalPrincipal)}`;
    numeric = Sres;
    formula = `S = R √ó [ ((1 + r)<sup>n</sup> - 1) / r ]`;
    subst = `S = ${sP} √ó [ ((1 + ${sPer})<sup>${sN}</sup> - 1) / ${sPer} ]`;

  } else if (mode === 'futureR_start'){
    const factor = (per === 0) ? periods : ((Math.pow(1 + per, periods) - 1) / per) * (1+per);
    const Sres = P * factor;
    const totalPrincipal = P * periods;
    out = `<strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (S): ${fmt(Sres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡∏ù‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏á‡∏ß‡∏î ${sP} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${n} ‡∏õ‡∏µ)\n‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏£‡∏ß‡∏°: ${fmt(totalPrincipal)}\n‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°: ${fmt(Sres - totalPrincipal)}`;
    numeric = Sres;
    formula = `S = R √ó [ ((1 + r)<sup>n</sup> - 1) / r ] √ó (1 + r)`;
    subst = `S = ${sP} √ó [ ((1 + ${sPer})<sup>${sN}</sup> - 1) / ${sPer} ] √ó (1 + ${sPer})`;

  } else if (mode === 'findR_end'){
    if (per === 0) { const Rres = S/periods; out = `<strong> ‡∏≠‡∏≠‡∏°‡∏á‡∏ß‡∏î‡∏•‡∏∞: ${fmt(Rres)} ‡∏ö‡∏≤‡∏ó</strong>`; numeric = Rres; }
    else { 
        const denom = ((Math.pow(1 + per, periods) - 1) / per); 
        if (denom===0) out = `<div class="error">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>`; 
        else { 
            const Rres = S/denom; 
            out = `<strong>üíµ ‡∏≠‡∏≠‡∏°‡∏á‡∏ß‡∏î‡∏•‡∏∞: ${fmt(Rres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ${sS} ‡πÉ‡∏ô ${n} ‡∏õ‡∏µ)`; 
            numeric = Rres; 
            formula = `R = S / [ ((1 + r)<sup>n</sup> - 1) / r ]`;
            subst = `R = ${sS} / [ ((1 + ${sPer})<sup>${sN}</sup> - 1) / ${sPer} ]`;
        } 
    }

  } else if (mode === 'findR_start'){
    if (per === 0) { const Rres = S/periods; out = `<strong> ‡∏≠‡∏≠‡∏°‡∏á‡∏ß‡∏î‡∏•‡∏∞: ${fmt(Rres)} ‡∏ö‡∏≤‡∏ó</strong>`; numeric = Rres; }
    else { 
        const denom = ((Math.pow(1 + per, periods) - 1) / per) * (1 + per); 
        if (denom===0) out = `<div class="error">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>`; 
        else { 
            const Rres = S/denom; 
            out = `<strong>üíµ ‡∏≠‡∏≠‡∏°‡∏á‡∏ß‡∏î‡∏•‡∏∞: ${fmt(Rres)} ‡∏ö‡∏≤‡∏ó</strong>\n(‡πÅ‡∏ö‡∏ö‡∏ù‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏á‡∏ß‡∏î)`; 
            numeric = Rres; 
            formula = `R = S / [ (((1 + r)<sup>n</sup> - 1) / r) √ó (1 + r) ]`;
            subst = `R = ${sS} / [ (((1 + ${sPer})<sup>${sN}</sup> - 1) / ${sPer}) √ó (1 + ${sPer}) ]`;
        } 
    }

  } else if (mode === 'findN_R_end'){
    const R_val = P; 
    if(R_val <= 0) out = `<div class="error">‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (R) ‡∏ï‡πâ‡∏≠‡∏á > 0</div>`;
    else {
      if(per === 0){ const nres = S / R_val / k; out = `<strong> ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${nres.toFixed(2)} ‡∏õ‡∏µ</strong>`; numeric = nres; }
      else {
        const num = 1 + (S*per)/R_val;
        if (num <= 0) out = `<div class="error">‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</div>`;
        else { 
            const N = Math.log(num) / Math.log(1+per); 
            const nres = N / k; 
            out = `<strong> ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${nres.toFixed(2)} ‡∏õ‡∏µ</strong>\n(‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${Math.ceil(N)} ‡∏á‡∏ß‡∏î)`; 
            numeric = nres; 
            formula = `n = ln(1 + (S √ó r) / R) / [ k √ó ln(1 + r) ]`;
            subst = `n = ln(1 + (${sS} √ó ${sPer}) / ${sP}) / [ ${k} √ó ln(1 + ${sPer}) ]`;
        }
      }
    }

  } else if (mode === 'findN_R_start'){
    const R_val = P;
    if(R_val <= 0) out = `<div class="error">‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (R) ‡∏ï‡πâ‡∏≠‡∏á > 0</div>`;
    else {
      if(per === 0){ const nres = S / R_val / k; out = `<strong> ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${nres.toFixed(2)} ‡∏õ‡∏µ</strong>`; numeric = nres; }
      else {
        const num = 1 + (S*per)/(R_val*(1+per));
        if (num <= 0) out = `<div class="error">‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•</div>`;
        else { 
            const N = Math.log(num) / Math.log(1+per); 
            const nres = N / k; 
            out = `<strong> ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${nres.toFixed(2)} ‡∏õ‡∏µ</strong>\n(‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${Math.ceil(N)} ‡∏á‡∏ß‡∏î)`; 
            numeric = nres; 
            formula = `n = ln(1 + (S √ó r) / (R(1+r))) / [ k √ó ln(1 + r) ]`;
            subst = `n = ln(1 + (${sS} √ó ${sPer}) / (${sP}(1+${sPer}))) / [ ${k} √ó ln(1 + ${sPer}) ]`;
        }
      }
    }
  
  } else if (mode === 'findN_gradient') {
      if (S <= P) {
           out = `<div class="error">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (S) ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å (a1)</div>`;
      } else {
           const nVal = solveN_Numerical(S, { P:P, r:per, d:D, g:0, k:k }, 'gradient');
           const totalPeriods = Math.ceil(nVal * k);
           out = `<strong>‚è≥ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${nVal.toFixed(2)} ‡∏õ‡∏µ</strong>\n(‡∏´‡∏£‡∏∑‡∏≠ ${totalPeriods} ‡∏á‡∏ß‡∏î)\n‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∞‡∏™‡∏°‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ${fmt(S)} ‡∏ö‡∏≤‡∏ó`;
           numeric = nVal;
           formula = `‡πÅ‡∏Å‡πâ‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏≤ n ‡∏à‡∏≤‡∏Å: S = FV_Arithmetic(n, a1, d, r)`;
           subst = `‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô ‡∏à‡∏∂‡∏á‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ä‡∏¥‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Numerical Method) ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏ô‡πÑ‡∏î‡πâ n ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ FV ‚âà ${fmt(S)}`;
      }

  } else if (mode === 'findN_geometric') {
      if (S <= P) {
           out = `<div class="error">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (S) ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å (a1)</div>`;
      } else {
           const nVal = solveN_Numerical(S, { P:P, r:per, d:0, g:G, k:k }, 'geometric');
           const totalPeriods = Math.ceil(nVal * k);
           out = `<strong>‚è≥ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${nVal.toFixed(2)} ‡∏õ‡∏µ</strong>\n(‡∏´‡∏£‡∏∑‡∏≠ ${totalPeriods} ‡∏á‡∏ß‡∏î)\n‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∞‡∏™‡∏°‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ${fmt(S)} ‡∏ö‡∏≤‡∏ó`;
           numeric = nVal;
           formula = `‡πÅ‡∏Å‡πâ‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏≤ n ‡∏à‡∏≤‡∏Å: S = [ a1(1+r) [ (1+r)<sup>n</sup> - (1+g)<sup>n</sup> ] ] / (r - g)`;
           subst = `‡∏™‡∏°‡∏Å‡∏≤‡∏£ Exponential ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏≤ n ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏à‡∏∂‡∏á‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ Numerical Method ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ n ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ FV ‚âà ${fmt(S)}`;
      }

  } else {
    out = '<div class="error">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö</div>';
  }

  // Final rendering
  let finalText = out.replace(/\n/g,'<br>');
  if(formula && !out.includes('error')) {
      finalText += `
        <div class="math-box">
           <div class="math-section">
             <span class="math-label"> ‡∏™‡∏π‡∏ï‡∏£ (Formula):</span>
             <span class="math-code">${formula}</span>
           </div>
           <div class="math-section">
             <span class="math-label"> ‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤ (Substitution):</span>
             <span class="math-code math-hl">${subst}</span>
           </div>
        </div>
      `;
  }
  
  el('output').innerHTML = `<div style="line-height:1.6">${finalText}</div>`;
  el('postTools').style.display = finalText ? 'block' : 'none';
  if (returnResult) return { text: out.replace(/<[^>]*>?/gm, ''), numeric: (isFinite(numeric) ? numeric : NaN) };
  return null;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Solver ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ N (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î findN)
function solveN_Numerical(targetS, inputs, type) {
    let low = 0.01;
    let high = 500.0; // ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 500 ‡∏õ‡∏µ
    let mid = 0;
    let computedS = 0;
    const { P, r, d, g, k } = inputs; 

    for (let i = 0; i < 100; i++) {
        mid = (low + high) / 2;
        const periods = mid * k;
        
        if (type === 'gradient') {
            if (r === 0) {
                 computedS = (periods/2) * (2*P + (periods-1)*d);
            } else {
                 const term1_top = P * (1+r) * (Math.pow(1+r, periods) - 1);
                 const term1 = term1_top / r;
                 const bracket_part1 = ( (1+r)*(Math.pow(1+r, periods) - 1) ) / (r*r);
                 const bracket_part2 = ( (1+r)*periods ) / r;
                 const term2 = d * (bracket_part1 - bracket_part2);
                 computedS = term1 + term2;
            }
        } else {
            const q = 1 + (g/100);
            if (Math.abs((1+r) - q) < 1e-9) {
                computedS = periods * P * Math.pow(1+r, periods-1);
            } else {
                const numerator = P * (1+r) * (Math.pow(1+r, periods) - Math.pow(q, periods));
                const denominator = (1+r) - q;
                computedS = numerator / denominator;
            }
        }
        if (Math.abs(computedS - targetS) < 1.0) break;
        if (computedS < targetS) low = mid;
        else high = mid;
    }
    return mid;
}


/* ============== entries UI ============== */
function renderEntries(){
  const container = el('entries'); container.innerHTML = '';
  if(entries.length === 0) container.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>';
  entries.slice().reverse().forEach((it, idx) => {
    const realIdx = entries.length - 1 - idx;
    const div = document.createElement('div'); div.className='entry';
    div.innerHTML = `
        <div class="entry-header">
            <div>
                <h3>${escapeHtml(it.name)}</h3>
                <div class="meta">${escapeHtml(it.modeLabel)} ¬∑ ${new Date(it.created).toLocaleString('th-TH')}</div>
            </div>
            <div class="badge">${isFinite(it.numeric) ? fmt(it.numeric) : 'N/A'}</div>
        </div>
        <div class="entry-content">${escapeHtml(it.text)}</div>
        <div class="entry-actions">
            <button class="secondary" onclick="loadToForm(${realIdx})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="danger" onclick="deleteEntry(${realIdx})">‡∏•‡∏ö</button>
        </div>
    `;
    container.appendChild(div);
  });
  renderSummary();
}

function deleteEntry(index){ if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return; entries.splice(index,1); saveEntries(); renderEntries(); }
function loadToForm(index){
  const it = entries[index];
  el('entryName').value = it.name || '';
  el('mode').value = it.mode;
  updateInputs();
  if(it.inputs.k) el('k').value = it.inputs.k;
  el('period').value = it.inputs.periodType || 'year';
  el('P').value = it.inputs.P || '';
  el('r').value = it.inputs.r || '';
  el('n').value = it.inputs.n || '';
  el('S').value = it.inputs.S || '';
  el('D').value = it.inputs.D || '';
  el('Q').value = it.inputs.Q || '';
  editingIndex = index;
  el('calcBtn').innerHTML = ' ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
  el('calcBtn').classList.remove('primary');
  el('calcBtn').classList.add('success');
  window.scrollTo({top:0,behavior:'smooth'});
}

function renderSummary(){
  const s = el('summary'); s.innerHTML = '';
  if (entries.length < 1) return;
  const last = entries[entries.length-1];
  // ‡πÅ‡∏™‡∏î‡∏á Summary ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  s.innerHTML = `<div style="padding:15px;background:#f1f5f9;border-radius:8px;font-size:14px;border:1px solid #cbd5e1;">
      <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${escapeHtml(last.name)} <br>
      <span style="font-size:1.2em;color:#2563eb;font-weight:bold">${fmt(last.numeric)}</span>
      ${ last.text.includes('‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥') ? '<br><span style="color:#10b981;font-size:0.9em">‚ú® ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥/‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏° ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</span>' : '' }
  </div>`;
}

function copyLatest(){
  if(entries.length===0) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
  const txt = entries[entries.length-1].text.replace(/<[^>]*>?/gm, '');
  navigator.clipboard.writeText(txt).then(()=>alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'));
}

/* =========================================
   GRAPH LOGIC (Smooth + Downsampling)
   ========================================= */

function generateScheduleData() {
  const mode = el('mode').value;
  const P = parseFloat(el('P').value) || 0; 
  const rawR = parseFloat(el('r').value) || 0;
  let n = parseFloat(el('n').value) || 0;
  const D = parseFloat(el('D').value) || 0; 
  const G = parseFloat(el('Q').value) || 0; 
  const S = parseFloat(el('S').value) || 0;
  
  let kInput = parseFloat(el('k').value);
  let k = (isNaN(kInput) || kInput <= 0) ? 12 : kInput; 
  let periodType = el('period').value;
  
  let r_annual = (periodType === 'month') ? rawR * 12 : rawR; 
  let r_per_period = (r_annual / 100) / k;
  
  // Simulation for findN
  if(mode.startsWith('findN') && S > 0 && P > 0) {
      if(Math.log(1+r_per_period) !== 0) {
          let estimatedN = Math.log(S/P) / (k * Math.log(1+r_per_period));
          if(estimatedN > 0 && estimatedN < 1000) n = estimatedN; 
      }
      if(n === 0) n = 10; 
  }

  let totalPeriods = Math.ceil(n * k);
  if(totalPeriods > 20000) totalPeriods = 20000; // Limit for safety
  
  let balance = 0;
  let accumulatedPrinciple = 0;
  let labels = [];
  let dataBalance = [];
  let dataPrincipal = [];
  let tableRows = [];

  // Initial State
  if(['futureP', 'presentP', 'findN_P', 'findR_P'].includes(mode)) {
      balance = P; accumulatedPrinciple = P;
  }

  labels.push(0);
  dataBalance.push(balance);
  dataPrincipal.push(accumulatedPrinciple);

  for(let i=1; i<=totalPeriods; i++){
      let interest = balance * r_per_period;
      let depositThisPeriod = 0;
      
      if(['futureP','presentP','findN_P','findR_P'].includes(mode)){
          depositThisPeriod = 0;
      } else if(mode.includes('gradient')) {
          depositThisPeriod = P + ( (i-1) * D );
      } else if(mode.includes('geometric')) {
          let g_rate = G/100;
          depositThisPeriod = P * Math.pow(1+g_rate, i-1);
      } else {
          depositThisPeriod = P;
      }

      if(mode.includes('start')){
          let preBal = balance + depositThisPeriod;
          balance = preBal * (1 + r_per_period);
          interest = balance - preBal; 
      } else {
          balance = balance + interest + depositThisPeriod;
      }

      accumulatedPrinciple += depositThisPeriod;

      labels.push(i);
      dataBalance.push(balance);
      dataPrincipal.push(accumulatedPrinciple);
      
      tableRows.push({ t: i, p: depositThisPeriod, int: interest, bal: balance });
  }
  
  return { labels, dataBalance, dataPrincipal, tableRows, k, totalPeriods };
}

function showSchedule(){
    const data = generateScheduleData();
    const area = el('scheduleArea');
    const wrap = el('scheduleWrap');
    area.style.display = 'block';
    el('chartArea').style.display = 'none';
    
    let html = `<table><thead><tr><th>‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å/‡∏á‡∏ß‡∏î</th><th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</th></tr></thead><tbody>`;
    const maxShow = 100;
    data.tableRows.forEach((row, idx) => {
        if(idx < maxShow || idx === data.tableRows.length - 1) {
             if(idx === maxShow && data.tableRows.length > maxShow+1) 
                 html += `<tr><td colspan="4" style="text-align:center;color:#94a3b8">... (‡∏ã‡πà‡∏≠‡∏ô ${data.tableRows.length - maxShow - 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ...</td></tr>`;
             else 
                 html += `<tr><td>${row.t}</td><td>${fmt(row.p)}</td><td style="color:#10b981">+${fmt(row.int)}</td><td style="font-weight:600">${fmt(row.bal)}</td></tr>`;
        }
    });
    html += `</tbody></table>`;
    wrap.innerHTML = html;
    area.scrollIntoView({behavior:'smooth'});
}

function downloadScheduleCSV(){
    const data = generateScheduleData();
    let csvContent = "data:text/csv;charset=utf-8,Period,Deposit,Interest,Balance\n";
    data.tableRows.forEach(row => { csvContent += `${row.t},${row.p.toFixed(2)},${row.int.toFixed(2)},${row.bal.toFixed(2)}\n`; });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "schedule.csv");
    document.body.appendChild(link);
    link.click();
    link.remove();
}

function clearCanvas(){ if(myChart){ myChart.destroy(); myChart = null; } }

function toggleChart(){
    const area = el('chartArea');
    const ctx = el('chartCanvas').getContext('2d');
    
    if(area.style.display === 'block') { area.style.display = 'none'; return; }
    area.style.display = 'block';
    el('scheduleArea').style.display = 'none';
    
    const rawData = generateScheduleData();
    
    // --- DOWNSAMPLING FOR SMOOTH CHART ---
    const maxPoints = 250; 
    const total = rawData.labels.length;
    let step = Math.ceil(total / maxPoints);
    if(step < 1) step = 1;

    const smoothLabels = rawData.labels.filter((_, i) => i % step === 0 || i === total - 1);
    const smoothBalance = rawData.dataBalance.filter((_, i) => i % step === 0 || i === total - 1);
    const smoothPrincipal = rawData.dataPrincipal.filter((_, i) => i % step === 0 || i === total - 1);

    clearCanvas();

    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: smoothLabels,
            datasets: [
                {
                    label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏∞‡∏™‡∏° (Balance)',
                    data: smoothBalance,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4, 
                    pointRadius: 0,
                    pointHoverRadius: 6
                },
                {
                    label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏™‡∏∞‡∏™‡∏°',
                    data: smoothPrincipal,
                    borderColor: '#94a3b8',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, 
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(c) { return c.dataset.label + ': ' + new Intl.NumberFormat('th-TH').format(c.parsed.y); },
                        title: function(c) { return '‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ' + c[0].label; }
                    }
                }
            },
            scales: {
                x: { title: { display: true, text: '‡∏á‡∏ß‡∏î‡πÄ‡∏ß‡∏•‡∏≤' }, grid: { display: false }, ticks: { maxTicksLimit: 10 } },
                y: {
                    beginAtZero: true,
                    ticks: { callback: function(v) { if(v>=1e6)return(v/1e6).toFixed(1)+'M'; if(v>=1e3)return(v/1e3).toFixed(0)+'k'; return v; } }
                }
            }
        }
    });
    
    setTimeout(() => area.scrollIntoView({behavior:'smooth', block:'start'}), 100);
}
</script>
</body>
</html>
